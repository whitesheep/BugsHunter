/*
 *
 *   Copyright 2010 Rondini Marco
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 *
 */

class Exploit extends ICommand {
	
	public db_exploit;
	public db_exploit_cms;
	public db_exploit_ver;
	public db_exploit_type;
	public db_exploit_hash;
	public nexploit;
	public hash_case;
	
		
	public method Exploit(){
		
		me.hash_case = [ "help"		: new MethodReference( me, help ),
				 "search" 	: new MethodReference( me, search ),			
				 "import" 	: new MethodReference( me, import ),
				 "install"	: new MethodReference( me, install ),
				 "uninstall"	: new MethodReference( me, uninstall )	];		// popolamento hash_case per comandi interni
				 
		me.nexploit = 0;
		me.db_exploit = [ : ];			// mappa totale degli exploit: da linguaggio in giù
		me.db_exploit_cms = [ : ];		// mappa parziale degli exploit: da cms in giù
		me.db_exploit_ver = [ : ];		// mappa parziale degli exploit: da versione cms in giù
		me.db_exploit_type = [ : ];		// mappa parziale degli exploit: da tipogia in giù
		me.db_exploit_hash = [ : ];		// mappa parziale degli exploit: dall'exploit singolo a descrizione.
		
		me.ICommand("exploit");
	}

	public method help(){
		println( "* exploit [search|import|install|uninstall]\t\t\t\t\tshow local folder" );
	}
	
	public method load_exploit(){
		/*
		 *
		 *	Per ogni file inserito nella cartella db/exploit mi importo la 
		 *	struttura per popolare l'hash db_exploit.
		 *
		 */
		foreach( file of readdir("./db/exploit/", false) ){
			if ( file["type"] != DT_DIR ){
				load("./db/exploit/" + file["name"]);
				me.nexploit++;		// un exploit in più!
				
				me.db_exploit_hash[__db_instance.Hash] = ["data" :  __db_instance.Description ];		//inserisco nuovo hash ( identificativo dell'exploit ) più descrizione dello stesso.
				me.db_exploit_hash[__db_instance.Hash]["parent"] = [ __db_instance.Lang, __db_instance.CMS_name, __db_instance.CMS_version, __db_instance.Type ];  // p
		
				if ( !me.db_exploit_type.has(__db_instance.Type) ){
					me.db_exploit_type[__db_instance.Type] = ["data" : &me.db_exploit_hash ];		//Tipo di exploit (Remote File Inclusion, SQL Injection, ....)
					me.db_exploit_type[__db_instance.Type]["parent"] = [ __db_instance.Lang, __db_instance.CMS_name, __db_instance.CMS_version ]; 
				}
			
				if ( !me.db_exploit_type.has(__db_instance.CMS_version) ){
					me.db_exploit_ver[__db_instance.CMS_version] = ["data" : &me.db_exploit_type ];		//Versione del CMS in questione (2.0, 3.1b, ....)
					me.db_exploit_ver[__db_instance.CMS_version]["parent"] = [ __db_instance.Lang, __db_instance.CMS_name];
				}
			
				if ( !me.db_exploit_type.has(__db_instance.CMS_name) ){
					me.db_exploit_cms[__db_instance.CMS_name] = ["data" : &me.db_exploit_ver ];		//Nome del CMS o modulo ( joomla, phpbb, pornbb, ... ) 
					me.db_exploit_cms[__db_instance.CMS_name]["parent"] = [ __db_instance.Lang ];
				}
			
				if ( !me.db_exploit.has(__db_instance.Lang) ) { 
					me.db_exploit[__db_instance.Lang] = &me.db_exploit_cms;
				}
			}
		}
		return me.nexploit;
	}

	public method exec( args ){
	
		if ( me.hash_case.has(args.split(" ")[0]) ){
			me.hash_case[args.split(" ")[0]].call( [me, args] );
		}
	}
	
	/*
	*		inizio metodi di sostituzione al case, per MethodReference.
	*/
	
	private method search (me, args){
		println(me.db_exploit_type["Sql Injection"]);
	}
	
	private method import( me, args){
	}
	
 	private method install( me, args ){
 	}
 	
 	private method uninstall( me, args){
 	}
 	
 	/*
 	*		Fine metodi ( per MethodReference )
 	*/	
}
/*
 * Creo l'istanza da far caricare al gestore principale.
 */
__cmd_instance = new Exploit();
